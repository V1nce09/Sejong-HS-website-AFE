<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>세종고 통합 포털</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">

    {% if session.get('user') %}
    <!-- 프로필: 이름 + 학번(또는 관리자) + 동작 메뉴 -->
    <div class="profile-mini" role="note" aria-label="사용자 프로필">
      <div class="avatar">{{ (session.get('display_name') or session.get('user'))[0] | upper }}</div>
      <div class="profile-text">
        <div class="profile-name">{{ session.get('display_name') or session.get('user') }}</div>
        <div class="profile-sub">
          {% if session.get('user') == 'admin' %}
            관리자
          {% else %}
            학번: {{ session.get('student_no') or '등록안됨' }}
          {% endif %}
        </div>
      </div>

      <!-- 점 버튼 및 드롭다운 -->
      <div class="profile-actions" aria-hidden="true">
        <button class="dots-btn" aria-label="메뉴" type="button">⋯</button>
        <div class="profile-dropdown" aria-hidden="true">
          <a href="{{ url_for('logout') }}" class="dropdown-item">로그아웃</a>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- 좌측 패널 -->
    <aside class="sidebar">
      <h3 style="color:#fff;margin:0 0 14px 0;">반 선택</h3>
      <form id="queryForm">
        <label style="color:#fff;font-weight:600;">날짜
          <input type="date" id="date" name="date" style="margin-top:6px;" value="{{ date[:4] + '-' + date[4:6] + '-' + date[6:] if date }}">
        </label>

        <label style="color:#fff;font-weight:600;">학년
          <input type="text" id="grade" name="grade" value="{{ grade }}">
        </label>

        <label style="color:#fff;font-weight:600;">반
          <input type="text" id="classroom" name="classroom" value="{{ classroom }}">
        </label>

        <button type="submit" style="margin-top:10px;background:#e67e22;color:#fff;padding:10px;border:none;border-radius:6px;cursor:pointer;width:100%;">조회</button>
      </form>
    </aside>

    <!-- 중앙 -->
    <main class="timetable-section">
      <h2 style="margin-top:0;">수업 일정 (2주)</h2>
      <p style="color:#34495e;">조회 시 시간표가 표시됩니다.</p>

      {% if timetable %}
        {% for day in timetable %}
          <div class="day-box">
            <strong>{{ day.date[:4] }}-{{ day.date[4:6] }}-{{ day.date[6:] }}</strong>
            <ul>
              {% for item in day.timetable %}
                <li>{{ item }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}
      {% else %}
        <p class="placeholder">시간표 정보가 없습니다.</p>
      {% endif %}
    </main>

    <!-- 우측 -->
    <aside class="meal-panel">
      <h3>오늘의 급식</h3>
      {% if meal %}
        {% for m in meal %}
          <div class="meal-item">
            <strong>{{ m.time }}</strong>
            <div style="white-space:pre-wrap;margin-top:6px;">{{ m.menu }}</div>
          </div>
        {% endfor %}
      {% else %}
        <p style="color:#324a5e;">급식 정보가 없습니다.</p>
      {% endif %}
    </aside>
</div>

<script>
/* 프로필 드롭다운 토글 및 외부 클릭 닫기 */
(function(){
  const profile = document.querySelector('.profile-mini');
  if (!profile) return;
  const btn = profile.querySelector('.dots-btn');
  const dropdown = profile.querySelector('.profile-dropdown');

  function closeDropdown(){
    if (!dropdown) return;
    dropdown.setAttribute('aria-hidden', 'true');
  }
  function openDropdown(){
    if (!dropdown) return;
    dropdown.setAttribute('aria-hidden', 'false');
  }

  document.addEventListener('click', function(e){
    // 버튼 클릭은 내부에서 처리
    if (profile.contains(e.target)) return;
    closeDropdown();
  });

  if (btn) {
    btn.addEventListener('click', function(e){
      e.stopPropagation();
      const isOpen = dropdown.getAttribute('aria-hidden') === 'false';
      if (isOpen) closeDropdown();
      else openDropdown();
    });
  }

  // Esc로 닫기
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') closeDropdown();
  });
})();

/* 기존의 클라이언트 조회 기능 유지: 폼 제출시 API 호출로 시간표/급식 불러오기 */
document.getElementById("queryForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const date = document.getElementById("date").value.replaceAll("-", "");
    const grade = document.getElementById("grade").value;
    const classroom = document.getElementById("classroom").value;

    fetch(`/api/data?date=${date}&grade=${grade}&classroom=${classroom}`)
        .then(response => response.json())
        .then(data => {
            const timetableContainer = document.querySelector(".timetable-section");
            // 간단 갱신: 페이지 내 중앙 영역을 다시 그림 (간단 구현)
            let html = '<h2 style="margin-top:0;">수업 일정 (2주)</h2>';
            if (data.timetable.length === 0) {
                html += '<p class="placeholder">시간표 정보가 없습니다.</p>';
            } else {
                data.timetable.forEach(day => {
                    const d = day.date;
                    html += `<div class="day-box"><strong>${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6)}</strong><ul>`;
                    day.timetable.forEach((s) => { html += `<li>${s}</li>`; });
                    html += '</ul></div>';
                });
            }
            timetableContainer.innerHTML = html;

            const mealPanel = document.querySelector(".meal-panel");
            let mealHtml = '<h3>오늘의 급식</h3>';
            if (data.meal.length > 0) {
                data.meal.forEach(m => {
                    mealHtml += `<div class="meal-item"><strong>${m.time}</strong><div style="white-space:pre-wrap;margin-top:6px;">${m.menu}</div></div>`;
                });
            } else {
                mealHtml += '<p style="color:#324a5e;">급식 정보가 없습니다.</p>';
            }
            mealPanel.innerHTML = mealHtml;
        });
});
</script>
</body>
</html>